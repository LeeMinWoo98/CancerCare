<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>cancercare – 비밀번호 재설정</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg:#f7f9fc;
            --card:#ffffff;
            --text:#0b1a2b;
            --muted:#6b7280;
            --brand:#2563eb; /* blue-600 */
            --brand-700:#1d4ed8;
            --outline:#e5e7eb;
            --shadow:0 10px 30px rgba(2, 17, 79, .08);
            --radius:16px;
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0;background:var(--bg);font-family:"Pretendard", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;color:var(--text)}
        .wrap{min-height:100%;display:grid;place-items:center;padding:40px 16px}

        .card{width:100%;max-width:420px;background:var(--card);border:1px solid var(--outline);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px}
        .brand{display:flex;align-items:center;gap:10px;margin-bottom:6px}
        .logo{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,#4f46e5,#22d3ee);color:#fff;font-size:14px;font-weight:800}
        .subtitle{color:var(--muted);font-size:13px;margin-top:4px}

        h1{margin:10px 0 2px;font-size:24px;letter-spacing:-.01em}

        .steps{display:flex;justify-content:center;margin:20px 0;gap:8px}
        .step{width:8px;height:8px;border-radius:50%;background:#e5e7eb}
        .step.active{background:var(--brand)}
        .step.completed{background:#10b981}

        form{margin-top:18px}
        .field{margin-bottom:14px}
        label{display:block;font-weight:600;margin-bottom:8px}
        .req{color:#ef4444;margin-left:4px}
        input[type=email],input[type=text],input[type=password]{width:100%;height:44px;border:1px solid var(--outline);border-radius:10px;padding:0 12px;font-size:15px;outline:none;background:#fff}
        input[type=email]::placeholder,input[type=text]::placeholder,input[type=password]::placeholder{color:#9ca3af}
        input[type=email]:focus,input[type=text]:focus,input[type=password]:focus{border-color:#94b5ff;box-shadow:0 0 0 3px rgba(37,99,235,.12)}

        .btn{width:100%;height:46px;border:none;border-radius:12px;background:var(--brand);color:#fff;font-weight:700;font-size:15px;cursor:pointer;margin-top:14px}
        .btn:hover{background:var(--brand-700)}
        .btn:disabled{background:#9ca3af;cursor:not-allowed}
        .btn.secondary{background:#6b7280;color:#fff}
        .btn.secondary:hover{background:#4b5563}

        .timer{background:#f0f9ff;border:1px solid #bae6fd;color:#0369a1;padding:10px;border-radius:8px;text-align:center;margin:10px 0;font-weight:600}
        .timer.expired{background:#fef2f2;border-color:#fecaca;color:#991b1b}

        .verification-section{display:none}
        .password-section{display:none}

        .code-input{display:flex;gap:8px;justify-content:center;margin:16px 0}
        .code-digit{width:40px;height:48px;text-align:center;font-size:18px;font-weight:600;border:2px solid var(--outline);border-radius:8px;outline:none}
        .code-digit:focus{border-color:#94b5ff;box-shadow:0 0 0 3px rgba(37,99,235,.12)}

        .resend-link{color:#2563eb;text-decoration:none;font-size:14px;margin-top:10px;display:inline-block}
        .resend-link:hover{text-decoration:underline}
        .resend-link:disabled{color:#9ca3af;pointer-events:none}

        .back-link{display:inline-flex;align-items:center;gap:6px;color:#2563eb;text-decoration:none;font-size:14px;margin-top:20px}
        .back-link:hover{text-decoration:underline}

        .alert{margin-top:12px;border:1px solid #fecaca;background:#fef2f2;color:#991b1b;border-radius:10px;padding:10px 12px;font-size:14px}
        .alert.success{background:#f0f9ff;border-color:#bae6fd;color:#0369a1}

        .step-indicator{text-align:center;margin:20px 0;color:var(--muted);font-size:14px}
    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <!-- 로고 / 브랜드 -->
        <div class="brand">
            <div class="logo">A</div>
            <strong>cancercare</strong>
        </div>

        <!-- 타이틀 -->
        <h2>비밀번호 재설정</h2>
        <div class="subtitle">단계별로 진행하여 새로운 비밀번호를 설정하세요</div>

        <!-- 진행 단계 표시 -->
        <div class="steps">
            <div class="step active" id="step1"></div>
            <div class="step" id="step2"></div>
            <div class="step" id="step3"></div>
        </div>
        <div class="step-indicator" id="stepText">1단계: 이메일 입력</div>

        <!-- 1단계: 이메일 입력 -->
        <div id="emailSection">
            <form id="emailForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="field">
                    <label for="email">이메일 <span class="req">*</span></label>
                    <input id="email" name="email" type="email" placeholder="가입 시 사용한 이메일을 입력하세요" required>
                </div>
                <button class="btn" type="submit" id="sendCodeBtn">인증코드 발송</button>
            </form>
        </div>

        <!-- 2단계: 인증코드 입력 -->
        <div id="verificationSection" class="verification-section">
            <div class="timer" id="timer">남은 시간: 05:00</div>
            
            <form id="verificationForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="field">
                    <label>인증번호 <span class="req">*</span></label>
                    <div class="code-input">
                        <input type="text" class="code-digit" maxlength="1" data-index="0">
                        <input type="text" class="code-digit" maxlength="1" data-index="1">
                        <input type="text" class="code-digit" maxlength="1" data-index="2">
                        <input type="text" class="code-digit" maxlength="1" data-index="3">
                        <input type="text" class="code-digit" maxlength="1" data-index="4">
                        <input type="text" class="code-digit" maxlength="1" data-index="5">
                    </div>
                </div>
                <button class="btn" type="submit" id="verifyBtn">인증번호 확인</button>
                <a href="#" class="resend-link" id="resendLink">인증번호 재발송</a>
            </form>
        </div>

        <!-- 3단계: 새 비밀번호 설정 -->
        <div id="passwordSection" class="password-section">
            <form id="passwordForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="field">
                    <label for="newPassword">새 비밀번호 <span class="req">*</span></label>
                    <input id="newPassword" name="newPassword" type="password" placeholder="새 비밀번호를 입력하세요" required>
                </div>
                <div class="field">
                    <label for="confirmPassword">비밀번호 확인 <span class="req">*</span></label>
                    <input id="confirmPassword" name="confirmPassword" type="password" placeholder="비밀번호를 다시 입력하세요" required>
                </div>
                <button class="btn" type="submit" id="resetBtn">비밀번호 변경</button>
            </form>
        </div>

        <!-- 결과 메시지 -->
        <div id="message" style="display:none"></div>

        <!-- 뒤로가기 링크 -->
        <a th:href="@{/find}" class="back-link">
            ← 찾기 메뉴로 돌아가기
        </a>
    </div>
</div>

<script th:inline="javascript">
const csrfToken = /*[[${_csrf.token}]]*/ '';
const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

let currentEmail = '';
let currentCode = '';
let timerInterval;
let timeLeft = 300; // 5분 = 300초

// 1단계: 이메일 입력 및 인증코드 발송
document.getElementById('emailForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    
    if (!email) {
        showMessage('error', '이메일을 입력해주세요.');
        return;
    }
    
    sendCodeBtn.disabled = true;
    sendCodeBtn.textContent = '발송 중...';
    
    try {
        const formData = new FormData();
        formData.append('email', email);
        formData.append('_csrf', csrfToken);
        
        const response = await fetch('/find/password/send-code', {
            method: 'POST',
            headers: {
                [csrfHeader]: csrfToken
            },
            body: formData
        });
        
        const data = await response.text();
        
        if (data === 'success') {
            currentEmail = email;
            showVerificationSection();
            startTimer();
            showMessage('success', '인증번호가 발송되었습니다. 이메일을 확인해주세요.');
        } else {
            showMessage('error', data);
        }
    } catch (error) {
        showMessage('error', '서버 오류가 발생했습니다.');
    } finally {
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = '인증코드 발송';
    }
});

// 2단계: 인증코드 확인
document.getElementById('verificationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const code = getVerificationCode();
    const verifyBtn = document.getElementById('verifyBtn');
    
    if (code.length !== 6) {
        showMessage('error', '6자리 인증번호를 모두 입력해주세요.');
        return;
    }
    
    verifyBtn.disabled = true;
    verifyBtn.textContent = '확인 중...';
    
    try {
        const formData = new FormData();
        formData.append('email', currentEmail);
        formData.append('code', code);
        formData.append('_csrf', csrfToken);
        
        const response = await fetch('/find/password/verify-code', {
            method: 'POST',
            headers: {
                [csrfHeader]: csrfToken
            },
            body: formData
        });
        
        const data = await response.text();
        
        if (data === 'success') {
            currentCode = code;
            showPasswordSection();
            clearInterval(timerInterval);
            showMessage('success', '인증이 완료되었습니다. 새 비밀번호를 설정해주세요.');
        } else {
            showMessage('error', data);
            clearVerificationCode();
        }
    } catch (error) {
        showMessage('error', '서버 오류가 발생했습니다.');
        clearVerificationCode();
    } finally {
        verifyBtn.disabled = false;
        verifyBtn.textContent = '인증번호 확인';
    }
});

// 3단계: 비밀번호 재설정
document.getElementById('passwordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const resetBtn = document.getElementById('resetBtn');
    
    if (newPassword !== confirmPassword) {
        showMessage('error', '비밀번호가 일치하지 않습니다.');
        return;
    }
    
    if (newPassword.length < 4) {
        showMessage('error', '비밀번호는 최소 4자 이상이어야 합니다.');
        return;
    }
    
    resetBtn.disabled = true;
    resetBtn.textContent = '변경 중...';
    
    try {
        const formData = new FormData();
        formData.append('email', currentEmail);
        formData.append('code', currentCode);
        formData.append('newPassword', newPassword);
        formData.append('confirmPassword', confirmPassword);
        formData.append('_csrf', csrfToken);
        
        const response = await fetch('/find/password/reset', {
            method: 'POST',
            headers: {
                [csrfHeader]: csrfToken
            },
            body: formData
        });
        
        const data = await response.text();
        
        if (data === 'success') {
            showMessage('success', '비밀번호가 성공적으로 변경되었습니다. 새로운 비밀번호로 로그인해주세요.');
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else {
            showMessage('error', data);
        }
    } catch (error) {
        showMessage('error', '서버 오류가 발생했습니다.');
    } finally {
        resetBtn.disabled = false;
        resetBtn.textContent = '비밀번호 변경';
    }
});

// 인증번호 재발송
document.getElementById('resendLink').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('emailForm').dispatchEvent(new Event('submit'));
});

// 코드 입력 자동 이동
document.querySelectorAll('.code-digit').forEach(input => {
    input.addEventListener('input', function() {
        if (this.value.length === 1) {
            const nextInput = document.querySelector(`[data-index="${parseInt(this.dataset.index) + 1}"]`);
            if (nextInput) {
                nextInput.focus();
            }
        }
    });
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && this.value === '') {
            const prevInput = document.querySelector(`[data-index="${parseInt(this.dataset.index) - 1}"]`);
            if (prevInput) {
                prevInput.focus();
            }
        }
    });
});

// 유틸리티 함수들
function showVerificationSection() {
    document.getElementById('emailSection').style.display = 'none';
    document.getElementById('verificationSection').style.display = 'block';
    document.getElementById('step1').className = 'step completed';
    document.getElementById('step2').className = 'step active';
    document.getElementById('stepText').textContent = '2단계: 인증번호 입력';
}

function showPasswordSection() {
    document.getElementById('verificationSection').style.display = 'none';
    document.getElementById('passwordSection').style.display = 'block';
    document.getElementById('step2').className = 'step completed';
    document.getElementById('step3').className = 'step active';
    document.getElementById('stepText').textContent = '3단계: 새 비밀번호 설정';
}

function getVerificationCode() {
    let code = '';
    document.querySelectorAll('.code-digit').forEach(input => {
        code += input.value;
    });
    return code;
}

function clearVerificationCode() {
    document.querySelectorAll('.code-digit').forEach(input => {
        input.value = '';
    });
    document.querySelector('.code-digit').focus();
}

function startTimer() {
    timeLeft = 300; // 5분 리셋
    const timerElement = document.getElementById('timer');
    
    timerInterval = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.textContent = `남은 시간: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timerElement.textContent = '인증 시간이 만료되었습니다.';
            timerElement.className = 'timer expired';
            document.getElementById('verifyBtn').disabled = true;
        }
        
        timeLeft--;
    }, 1000);
}

function showMessage(type, text) {
    const messageDiv = document.getElementById('message');
    messageDiv.className = `alert ${type}`;
    messageDiv.textContent = text;
    messageDiv.style.display = 'block';
    
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 5000);
}
</script>
</body>
</html>
