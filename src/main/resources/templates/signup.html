<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="_csrf" th:content="${_csrf.token}">
	<meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>cancercare – 회원가입</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg:#f7f9fc;--card:#fff;--text:#0b1a2b;--muted:#6b7280;--brand:#2563eb;--brand-700:#1d4ed8;--outline:#e5e7eb;--radius:16px;--shadow:0 10px 30px rgba(2,17,79,.08)
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0;background:var(--bg);font-family:"Pretendard",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;color:var(--text)}
        .wrap{min-height:100%;display:grid;place-items:center;padding:40px 16px}
        .card{width:100%;max-width:520px;background:var(--card);border:1px solid var(--outline);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px}
        .brand{display:flex;align-items:center;gap:10px;margin-bottom:8px}
        .logo{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,#4f46e5,#22d3ee);color:#fff;font-size:14px;font-weight:800}
        h1{margin:8px 0 2px;font-size:24px}
        .subtitle{color:var(--muted);font-size:13px;margin-bottom:8px}

        form{margin-top:12px}
        .grid{display:grid;grid-template-columns:1fr;gap:14px}
        .row{display:grid;grid-template-columns:1fr;gap:10px}
        label{font-weight:600;display:block;margin-bottom:8px}
        .req{color:#ef4444;margin-left:4px}
        input,select{width:100%;height:44px;border:1px solid var(--outline);border-radius:10px;padding:0 12px;font-size:15px;background:#fff;outline:none}
        input:focus,select:focus{border-color:#94b5ff;box-shadow:0 0 0 3px rgba(37,99,235,.12)}
        input::placeholder{color:#9ca3af}

        .email-row{display:grid;grid-template-columns:1fr 60px 1fr;gap:8px;align-items:center}
        .at{justify-self:center;color:#6b7280}

        .btn{width:100%;height:46px;border:none;border-radius:12px;background:var(--brand);color:#fff;font-weight:700;font-size:15px;cursor:pointer;margin-top:6px}
        .btn:hover{background:var(--brand-700)}

        .links{margin-top:14px;text-align:center;font-size:14px}
        .links a{color:#2563eb;text-decoration:none}
        .links a:hover{text-decoration:underline}

        .err{color:#dc2626;font-size:12px;margin-top:6px}
        .alert{margin-bottom:10px;border:1px solid #fde68a;background:#fffbeb;color:#78350f;border-radius:10px;padding:10px 12px;font-size:13px}
        
        input[type="checkbox"] {
            width: auto;
            height: auto;
            margin-right: 6px;
        }
        .terms-scroll-box {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid var(--outline);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 14px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--muted);
        }

        @media(min-width:600px){
            .row-2{grid-template-columns:1fr 1fr}
        }
    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <div class="brand">
            <div class="logo">A</div>
            <strong>cancercare</strong>
        </div>
        <h1>새로운 계정을 만들어보세요</h1>
        <div class="subtitle">cancercare 계정에 가입하세요</div>

        <form th:action="@{/signup}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="grid">
                <div>
                    <label for="loginId">아이디 <span class="req">*</span></label>
                    <input id="loginId" name="loginId" type="text" placeholder="아이디를 입력하세요" required>
                </div>

                <div>
                    <label for="name">이름 <span class="req">*</span></label>
                    <input id="name" name="name" type="text" placeholder="이름을 입력하세요" required>
                </div>

                <div>
                    <label>이메일 주소 <span class="req">*</span></label>
                    <div style="display:flex;gap:8px;">
                        <input id="email" name="email" type="email" placeholder="이메일을 입력하세요" required style="flex:1;">
                        <button type="button" id="sendCodeBtn" style="width:100px;height:44px;">인증번호 전송</button>
                    </div>
                    <div id="timerMsg" style="margin-top:6px;font-size:12px;color:#2563eb;font-weight:600;"></div>
                </div>

                <div>
                    <label for="verificationCode">인증번호</label>
                    <div style="display:flex;gap:8px;">
                        <input id="verificationCode" name="verificationCode" type="text" placeholder="인증번호 6자리" maxlength="6" style="flex:1;">
                        <button type="button" id="verifyCodeBtn" style="width:100px;height:44px;">인증 확인</button>
                    </div>
                    <div id="verifyResult" style="margin-top:6px;font-size:12px;"></div>
                </div>

                <div class="row row-2">
                    <div>
                        <label for="password">비밀번호 <span class="req">*</span></label>
                        <input id="password" name="password" type="password" placeholder="비밀번호를 입력하세요" required>
                    </div>
                    <div>
                        <label for="passwordConfirm">비밀번호 확인 <span class="req">*</span></label>
                        <input id="passwordConfirm" name="passwordConfirm" type="password" placeholder="비밀번호를 다시 입력하세요" required>
                        <div id="passwordMatchMsg" style="margin-top:6px;font-size:12px;"></div>
                    </div>
                </div>

                <div>
                    <label for="gender">성별</label>
                    <select id="gender" name="gender">
                        <option value="N" selected>선택 안 함</option>
                        <option value="FEMALE">여성</option>
                        <option value="MALE">남성</option>
                    </select>
                </div>

                <div>
                    <label for="birthdate">생년월일 <span class="req">*</span></label>
                    <input id="birthdate" name="birthdate" type="date" required>
                </div>

                <div class="terms-container">
                    <p><strong>CancerCare 이용 약관(필수)</strong></p>
                    <div class="terms-scroll-box">
                        <p><strong>제1조 (목적)</strong></p>
                        <p>본 약관은 CancerCare (이하 '회사')가 운영하는 웹사이트 'Cancercare.com' (이하 '사이트')에서 제공하는 AI 기반 헬스케어 서비스(이하 '서비스')를 이용함에 있어 '회사'와 이용자의 권리, 의무 및 책임사항을 규정함을 목적으로 합니다.</p>
                        <p><strong>제2조 (정의)</strong></p>
                        <p>1. '사이트'란 '회사'가 AI 기술을 활용한 암 위험도 예측 및 챗봇 상담 등의 서비스를 이용자에게 제공하기 위하여 컴퓨터 등 정보통신설비를 이용하여 구축한 가상의 공간을 말합니다.</p>
                        <p>2. '이용자'란 '사이트'에 접속하여 본 약관에 따라 '회사'가 제공하는 서비스를 받는 회원 및 비회원을 말합니다.</p>
                        <p>3. '회원'이라 함은 '사이트'에 개인정보를 제공하여 회원등록을 한 자로서, '사이트'의 정보를 지속적으로 제공받으며, '사이트'가 제공하는 서비스를 계속적으로 이용할 수 있는 자를 말합니다.</p>
                        <p>4. '비회원'이라 함은 회원에 가입하지 않고 '사이트'가 제공하는 서비스를 이용하는 자를 말합니다.</p>
                        <p><strong>제8조 (AI 서비스의 한계 및 면책)</strong></p>
                        <p>1. 본 약관에 명시된 AI 기반 암 위험도 예측 결과 및 챗봇 상담 내용은 의학적 진단이나 전문적인 의료 행위가 아니며, 단지 이용자의 건강 관리를 돕기 위한 참고용 정보입니다.</p>
                        <p>2. 이용자는 본 서비스에서 제공된 정보를 어떠한 경우에도 의료진의 진단 및 처방을 대체하는 용도로 사용해서는 안 됩니다.</p>
                        <p>3. '회사'는 서비스에 포함된 정보의 정확성, 완전성, 신뢰성을 보증하지 않으며, 이로 인해 발생한 직간접적인 손해에 대해 어떠한 책임도 부담하지 않습니다.</p>
                        <p><strong>제9조 (민감 정보의 수집 및 활용)</strong></p>
                        <p>1. '회사'는 AI 암 예측 서비스 제공을 위해 이용자의 동의를 얻어 CT, MRI, 내시경 영상 등 민감한 의료 정보를 수집할 수 있습니다.</p>
                        <p>2. 수집된 민감 정보는 암 예측 모델의 성능 개선 및 연구 개발 목적으로만 사용되며, 이 과정에서 개인을 식별할 수 있는 정보는 모두 비식별화 또는 암호화 처리됩니다.</p>
                    </div>
                    <label>
                        <input type="checkbox" id="termsAgree" name="termsAgree">
                        이용 약관에 동의합니다 <span class="req">*</span>
                    </label>
                    <div id="termsErrorMsg" class="err" style="display: none;">약관 확인 후 동의해주세요.</div>
                </div>

                <button class="btn" type="submit" id="submitBtn" disabled>회원가입</button>
            </div>
        </form>

        <div class="links">
            이미 계정이 있으신가요? <a th:href="@{/login}">로그인</a>
        </div>
    </div>
</div>

<script>
    let isEmailVerified = false;
    let isPasswordMatching = false;
    let isTermsAgreed = false;
    let timerInterval = null;

    // 비밀번호 일치 확인
    function checkPasswordMatch() {
        const password = document.getElementById('password').value;
        const passwordConfirm = document.getElementById('passwordConfirm').value;
        const msgDiv = document.getElementById('passwordMatchMsg');
        
        if (passwordConfirm === '') {
            msgDiv.innerHTML = '';
            isPasswordMatching = false;
        } else if (password === passwordConfirm) {
            msgDiv.innerHTML = '<span style="color:green;">✓ 비밀번호가 일치합니다.</span>';
            isPasswordMatching = true;
        } else {
            msgDiv.innerHTML = '<span style="color:red;">✗ 비밀번호가 일치하지 않습니다.</span>';
            isPasswordMatching = false;
        }
        updateSubmitButton();
    }

    // 이용 약관 동의 확인
    function checkTermsAgreement() {
        isTermsAgreed = document.getElementById('termsAgree').checked;
        if (isTermsAgreed) {
            document.getElementById('termsErrorMsg').style.display = 'none';
        }
        updateSubmitButton();
    }

    // 회원가입 버튼 활성화 상태 업데이트
    function updateSubmitButton() {
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = !(isEmailVerified && isPasswordMatching && isTermsAgreed);
    }

    // 타이머 시작 함수
    function startTimer(minutes) {
        let timeLeft = minutes * 60;
        const timerDiv = document.getElementById('timerMsg');
        
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        timerInterval = setInterval(function() {
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            
            timerDiv.innerHTML = `유효시간: ${mins}:${secs.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerDiv.innerHTML = '<span style="color:red;">⏰ 인증번호가 만료되었습니다. 다시 전송해주세요.</span>';
                timerInterval = null;
            }
            timeLeft--;
        }, 1000);
    }
    
    // 폼 제출 시 약관 동의 최종 확인
    document.querySelector('form').addEventListener('submit', function(event) {
        if (!document.getElementById('termsAgree').checked) {
            event.preventDefault();
            document.getElementById('termsErrorMsg').style.display = 'block';
        }
    });

    // 이벤트 리스너 추가
    document.getElementById('password').addEventListener('input', checkPasswordMatch);
    document.getElementById('passwordConfirm').addEventListener('input', checkPasswordMatch);
    document.getElementById('termsAgree').addEventListener('change', checkTermsAgreement);

    // 인증번호 전송 버튼 클릭
    document.getElementById('sendCodeBtn').addEventListener('click', function() {
        const email = document.getElementById('email').value;
        if (!email) {
            alert('이메일을 입력하세요.');
            return;
        }
        const token = document.querySelector("meta[name='_csrf']").getAttribute("content");
        const headerName = document.querySelector("meta[name='_csrf_header']").getAttribute("content");
        fetch('/signup/send-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                [headerName]: token
            },
            body: new URLSearchParams({email: email, '_csrf': document.querySelector('input[name="_csrf"]').value})
        })
        .then(response => response.text())
        .then(result => {
            if (result === 'success') {
                alert('인증번호가 전송되었습니다. (유효시간: 5분)');
                startTimer(5);
            } else if (result === '이미 사용 중인 이메일입니다.') {
                alert('이미 가입된 계정입니다.');
            } else if (result === '유효하지 않은 이메일입니다.') {
                alert('유효하지 않은 이메일입니다.');
            } else {
                alert('인증번호 전송에 실패했습니다.');
            }
        });
    });

    // 인증번호 확인 버튼 클릭
    document.getElementById('verifyCodeBtn').addEventListener('click', function() {
        const email = document.getElementById('email').value;
        const code = document.getElementById('verificationCode').value;
        if (!email || !code) {
            alert('이메일과 인증번호를 모두 입력하세요.');
            return;
        }
        
        fetch('/signup/verify-code', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({email: email, code: code, '_csrf': document.querySelector('input[name="_csrf"]').value})
        })
        .then(response => response.text())
        .then(result => {
            const resultDiv = document.getElementById('verifyResult');
            if (result === 'success') {
                resultDiv.innerHTML = '<span style="color:green;">✓ 이메일 인증이 완료되었습니다.</span>';
                isEmailVerified = true;
                if (timerInterval) {
                    clearInterval(timerInterval);
                    document.getElementById('timerMsg').innerHTML = '<span style="color:green;">✓ 인증 완료</span>';
                }
            } else {
                resultDiv.innerHTML = '<span style="color:red;">✗ 인증번호가 일치하지 않습니다.</span>';
                isEmailVerified = false;
            }
            updateSubmitButton();
        });
    });
</script>
</body>
</html>