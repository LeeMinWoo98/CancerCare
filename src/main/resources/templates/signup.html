<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>cancercare – 회원가입</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg:#f7f9fc;--card:#fff;--text:#0b1a2b;--muted:#6b7280;--brand:#2563eb;--brand-700:#1d4ed8;--outline:#e5e7eb;--radius:16px;--shadow:0 10px 30px rgba(2,17,79,.08)
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0;background:var(--bg);font-family:"Pretendard",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;color:var(--text)}
        .wrap{min-height:100%;display:grid;place-items:center;padding:40px 16px}
        .card{width:100%;max-width:520px;background:var(--card);border:1px solid var(--outline);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px}
        .brand{display:flex;align-items:center;gap:10px;margin-bottom:8px}
        .logo{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,#4f46e5,#22d3ee);color:#fff;font-size:14px;font-weight:800}
        h1{margin:8px 0 2px;font-size:24px}
        .subtitle{color:var(--muted);font-size:13px;margin-bottom:8px}

        form{margin-top:12px}
        .grid{display:grid;grid-template-columns:1fr;gap:14px}
        .row{display:grid;grid-template-columns:1fr;gap:10px}
        label{font-weight:600;display:block;margin-bottom:8px}
        .req{color:#ef4444;margin-left:4px}
        input,select{width:100%;height:44px;border:1px solid var(--outline);border-radius:10px;padding:0 12px;font-size:15px;background:#fff;outline:none}
        input:focus,select:focus{border-color:#94b5ff;box-shadow:0 0 0 3px rgba(37,99,235,.12)}
        input::placeholder{color:#9ca3af}

        .email-row{display:grid;grid-template-columns:1fr 60px 1fr;gap:8px;align-items:center}
        .at{justify-self:center;color:#6b7280}

        .btn{width:100%;height:46px;border:none;border-radius:12px;background:var(--brand);color:#fff;font-weight:700;font-size:15px;cursor:pointer;margin-top:6px}
        .btn:hover{background:var(--brand-700)}

        .links{margin-top:14px;text-align:center;font-size:14px}
        .links a{color:#2563eb;text-decoration:none}
        .links a:hover{text-decoration:underline}

        .err{color:#dc2626;font-size:12px;margin-top:6px}
        .alert{margin-bottom:10px;border:1px solid #fde68a;background:#fffbeb;color:#78350f;border-radius:10px;padding:10px 12px;font-size:13px}

        @media(min-width:640px){
            .row-2{grid-template-columns:1fr 1fr}
        }
    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <div class="brand">
            <div class="logo">A</div>
            <strong>cancercare</strong>
        </div>
        <h1>새로운 계정을 만들어보세요</h1>
        <div class="subtitle">cancercare 계정에 가입하세요</div>

        <form th:action="@{/signup}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="grid">
                <!-- 아이디 -->
                <div>
                    <label for="loginId">아이디 <span class="req">*</span></label>
                    <input id="loginId" name="loginId" type="text" placeholder="아이디를 입력하세요" required>
                </div>

                <!-- 이름 -->
                <div>
                    <label for="name">이름 <span class="req">*</span></label>
                    <input id="name" name="name" type="text" placeholder="이름을 입력하세요" required>
                </div>

                <!-- 이메일 + 인증 -->
                <div>
                    <label>이메일 주소 <span class="req">*</span></label>
                    <div style="display:flex;gap:8px;">
                        <input id="email" name="email" type="email" placeholder="이메일을 입력하세요" required style="flex:1;">
                        <button type="button" id="sendCodeBtn" style="width:100px;height:44px;">인증번호 전송</button>
                    </div>
                    <div id="timerMsg" style="margin-top:6px;font-size:12px;color:#2563eb;font-weight:600;"></div>
                </div>

                <!-- 인증번호 입력 -->
                <div>
                    <label for="verificationCode">인증번호</label>
                    <div style="display:flex;gap:8px;">
                        <input id="verificationCode" name="verificationCode" type="text" placeholder="인증번호 6자리" maxlength="6" style="flex:1;">
                        <button type="button" id="verifyCodeBtn" style="width:100px;height:44px;">인증 확인</button>
                    </div>
                    <div id="verifyResult" style="margin-top:6px;font-size:12px;"></div>
                </div>

                <!-- 비밀번호 / 확인 -->
                <div class="row row-2">
                    <div>
                        <label for="password">비밀번호 <span class="req">*</span></label>
                        <input id="password" name="password" type="password" placeholder="비밀번호를 입력하세요" required>
                    </div>
                    <div>
                        <label for="passwordConfirm">비밀번호 확인 <span class="req">*</span></label>
                        <input id="passwordConfirm" name="passwordConfirm" type="password" placeholder="비밀번호를 다시 입력하세요" required>
                        <div id="passwordMatchMsg" style="margin-top:6px;font-size:12px;"></div>
                    </div>
                </div>

                <!-- 성별 -->
                <div>
                    <label for="gender">성별</label>
                    <select id="gender" name="gender">
                        <option value="N" selected>선택 안 함</option>
                        <option value="FEMALE">여성</option>
                        <option value="MALE">남성</option>
                    </select>
                </div>

                <!-- 생년월일 -->
                <div>
                    <label for="birthdate">생년월일 <span class="req">*</span></label>
                    <input id="birthdate" name="birthdate" type="date" required>
                </div>

                <button class="btn" type="submit" id="submitBtn" disabled>회원가입</button>
            </div>
        </form>

        <div class="links">
            이미 계정이 있으신가요? <a th:href="@{/login}">로그인</a>
        </div>
    </div>
</div>

<script>
let isEmailVerified = false;
let isPasswordMatching = false;
let timerInterval = null;

// 비밀번호 일치 확인
function checkPasswordMatch() {
    const password = document.getElementById('password').value;
    const passwordConfirm = document.getElementById('passwordConfirm').value;
    const msgDiv = document.getElementById('passwordMatchMsg');
    
    if (passwordConfirm === '') {
        msgDiv.innerHTML = '';
        isPasswordMatching = false;
    } else if (password === passwordConfirm) {
        msgDiv.innerHTML = '<span style="color:green;">✓ 비밀번호가 일치합니다.</span>';
        isPasswordMatching = true;
    } else {
        msgDiv.innerHTML = '<span style="color:red;">✗ 비밀번호가 일치하지 않습니다.</span>';
        isPasswordMatching = false;
    }
    updateSubmitButton();
}

// 회원가입 버튼 활성화 상태 업데이트
function updateSubmitButton() {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = !(isEmailVerified && isPasswordMatching);
}

// 타이머 시작 함수
function startTimer(minutes) {
    let timeLeft = minutes * 60; // 초 단위로 변환
    const timerDiv = document.getElementById('timerMsg');
    
    // 기존 타이머가 있다면 정리
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    
    timerInterval = setInterval(function() {
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        
        timerDiv.innerHTML = `유효시간: ${mins}:${secs.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timerDiv.innerHTML = '<span style="color:red;">⏰ 인증번호가 만료되었습니다. 다시 전송해주세요.</span>';
            timerInterval = null;
        }
        
        timeLeft--;
    }, 1000);
}

// 비밀번호 필드에 이벤트 리스너 추가
document.getElementById('password').addEventListener('input', checkPasswordMatch);
document.getElementById('passwordConfirm').addEventListener('input', checkPasswordMatch);

document.getElementById('sendCodeBtn').addEventListener('click', function() {
    const email = document.getElementById('email').value;
    if (!email) {
        alert('이메일을 입력하세요.');
        return;
    }
    
    fetch('/signup/send-code', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({email: email, '_csrf': document.querySelector('input[name="_csrf"]').value})
    })
    .then(response => response.text())
    .then(result => {
        if (result === 'success') {
            alert('인증번호가 전송되었습니다. (유효시간: 5분)');
            startTimer(5); // 5분 타이머 시작
        } else if (result === '이미 사용 중인 이메일입니다.') {
            alert('이미 가입된 계정입니다.');
        } else if (result === '유효하지 않은 이메일입니다.') {
            alert('유효하지 않은 이메일입니다.');
        } else {
            alert('인증번호 전송에 실패했습니다.');
        }
    });
});

document.getElementById('verifyCodeBtn').addEventListener('click', function() {
    const email = document.getElementById('email').value;
    const code = document.getElementById('verificationCode').value;
    if (!email || !code) {
        alert('이메일과 인증번호를 모두 입력하세요.');
        return;
    }
    
    fetch('/signup/verify-code', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({email: email, code: code, '_csrf': document.querySelector('input[name="_csrf"]').value})
    })
    .then(response => response.text())
    .then(result => {
        const resultDiv = document.getElementById('verifyResult');
        if (result === 'success') {
            resultDiv.innerHTML = '<span style="color:green;">✓ 이메일 인증이 완료되었습니다.</span>';
            isEmailVerified = true;
            // 인증 성공 시 타이머 정지
            if (timerInterval) {
                clearInterval(timerInterval);
                document.getElementById('timerMsg').innerHTML = '<span style="color:green;">✓ 인증 완료</span>';
            }
        } else {
            resultDiv.innerHTML = '<span style="color:red;">✗ 인증번호가 일치하지 않습니다.</span>';
            isEmailVerified = false;
        }
        updateSubmitButton();
    });
});
</script>
</body>
</html>