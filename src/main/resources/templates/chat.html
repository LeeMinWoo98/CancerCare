<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>CancelCare - AI 의료 상담 서비스</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/chat.css}">

    <style>
        .chat-item {
            transition: background-color 0.3s ease;
            border-radius: 8px;
            margin: 4px 0;
            cursor: pointer;
        }
        .chat-item:hover {
            background-color: #4a5568;
        }
        .chat-item.active {
            background-color: #2c5282;
        }
    </style>
</head>
<body class="chat-page">

<div th:replace="~{fragments/header :: headerFragment}"></div>

<input type="hidden" id="diagnosisId" th:value="${diagnosisId != null ? diagnosisId : 1}" />

<div class="chat-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn">새로운 상담 시작</button>
        </div>
        <div class="chat-list">
            <div class="chat-item active" data-category="general">
                <div class="category-icon">💬</div>
                <div class="category-info">
                    <div class="chat-title">일반 상담</div>
                    <div class="chat-preview">기본적인 상담 서비스</div>
                </div>
            </div>
            <div class="chat-item" data-category="symptoms">
                <div class="category-icon">🩺</div>
                <div class="category-info">
                    <div class="chat-title">증상 문의</div>
                    <div class="chat-preview">증상에 대한 문의</div>
                </div>
            </div>
            <div class="chat-item" data-category="prevention">
                <div class="category-icon">🛡️</div>
                <div class="category-info">
                    <div class="chat-title">예방 관리</div>
                    <div class="chat-preview">질병 예방 및 관리</div>
                </div>
            </div>
            <div class="chat-item" data-category="checkup">
                <div class="category-icon">📋</div>
                <div class="category-info">
                    <div class="chat-title">검진 정보</div>
                    <div class="chat-preview">건강검진 관련 정보</div>
                </div>
            </div>
            <div class="chat-item" data-category="nutrition">
                <div class="category-icon">🍎</div>
                <div class="category-info">
                    <div class="chat-title">영양 상담</div>
                    <div class="chat-preview">영양 및 식단 상담</div>
                </div>
            </div>
        </div>
        <div class="sidebar-footer" sec:authorize="isAuthenticated()">
            <div class="user-info">
                <div class="user-avatar" th:text="${#strings.substring(#authentication.name, 0, 1).toUpperCase()}">U</div>
                <div>
                    <div style="font-size: 14px; font-weight: 500;" sec:authentication="name">사용자이름</div>
                    <div style="font-size: 12px; color: #bdc3c7;">온라인</div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-chat">
         <div class="chat-header">
            <div class="ai-avatar">AI</div>
            <div class="ai-info">
                <h3>CancelCare AI 상담</h3>
                <div class="ai-status">의료 상담 서비스</div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div th:each="message : ${chatHistory}" class="message" th:classappend="${message.sender.name() == 'user'} ? 'user' : 'ai'">
                <div class="message-avatar"
                     th:text="${message.sender.name() == 'user'} ? ${#strings.substring(#authentication.name, 0, 1).toUpperCase()} : 'AI'">
                </div>
                <div class="message-content" th:text="${message.messageText}"></div>
            </div>
        </div>

        <div class="chat-input-container">
            <form id="chatForm">
                <div class="chat-input-wrapper">
                    <textarea name="message" id="messageInput" class="chat-input" placeholder="메시지를 입력하세요..." rows="1" required></textarea>
                    <button type="submit" class="send-btn" id="sendBtn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13"></path>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        // DOM 요소 가져오기
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const newChatBtn = document.querySelector('.new-chat-btn');
        const chatItems = document.querySelectorAll('.chat-item');

        // 로그인한 사용자 이름의 첫 글자 (Thymeleaf로부터 안전하게 전달받음)
        const currentUserInitial = /*[[${#authorization.expression('isAuthenticated()')} ? ${#strings.substring(#authentication.name, 0, 1).toUpperCase()} : 'U']]*/ 'U';

        // --- 함수 정의 ---

        // 채팅 스크롤을 항상 맨 아래로 이동
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 메시지를 화면에 추가하는 함수
        function addMessage(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            const avatar = isUser ? currentUserInitial : 'AI';
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${text.replace(/\n/g, '<br>')}</div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // 서버로 메시지를 전송하는 함수
        function sendMessage() {
            const messageText = messageInput.value.trim();
            const diagnosisId = document.getElementById('diagnosisId').value;
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            if (!messageText) return;

            addMessage(messageText, true);

            fetch('/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({
                    message: messageText,
                    diagnosisId: parseInt(diagnosisId)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addMessage(data.response, false);
                } else {
                    addMessage('오류가 발생했습니다: ' + (data.error || '알 수 없는 오류'), false);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('네트워크 오류가 발생했습니다.', false);
            });

            messageInput.value = '';
            messageInput.style.height = 'auto'; // 높이 초기화
            sendBtn.disabled = true;
        }

        // --- 이벤트 리스너 설정 ---

        // 페이지 로드 시 스크롤 맨 아래로
        scrollToBottom();

        // 입력창 자동 높이 조절 및 전송 버튼 활성화
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px'; // 최대 높이 120px
            sendBtn.disabled = !this.value.trim();
        });

        // Enter 키로 메시지 전송 (Shift+Enter는 줄바꿈)
        messageInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!sendBtn.disabled) {
                    sendMessage();
                }
            }
        });

        // 폼 제출(전송 버튼 클릭) 시 메시지 전송
        chatForm.addEventListener('submit', function (e) {
            e.preventDefault();
            sendMessage();
        });

        // 새 상담 시작 버튼
        newChatBtn.addEventListener('click', () => {
             alert('새로운 상담을 시작합니다!');
             // 필요하다면 채팅 내역 초기화 로직 추가
        });

        // 사이드바 카테고리 선택
        chatItems.forEach(item => {
            item.addEventListener('click', function() {
                chatItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                const category = this.dataset.category;
                const categoryMessages = {
                    'general': '일반 상담을 선택하셨습니다. 무엇을 도와드릴까요?',
                    'symptoms': '증상 문의를 선택하셨습니다. 어떤 증상이 있으신가요?',
                    'prevention': '예방 관리를 선택하셨습니다. 어떤 예방법이 궁금하신가요?',
                    'checkup': '검진 정보를 선택하셨습니다. 어떤 검진 정보를 원하시나요?',
                    'nutrition': '영양 상담을 선택하셨습니다. 영양 관련 질문을 해보세요!'
                };
                addMessage(categoryMessages[category], false); // AI가 응답하는 것처럼 메시지 추가
            });
        });

        // 진단 페이지에서 넘어온 경우, 첫 질문을 자동으로 전송
        const urlParams = new URLSearchParams(window.location.search);
        const diagnosisResult = urlParams.get('diagnosis');
        if (diagnosisResult) {
            addMessage(`'${diagnosisResult}' 진단 결과에 대해 더 자세히 알려주세요.`, true);
            
            // fetch 전송을 위해 messageInput에 잠시 값을 할당
            messageInput.value = `'${diagnosisResult}' 진단 결과에 대해 더 자세히 알려주세요.`;
            sendMessage();
            messageInput.value = ''; // 전송 후 다시 비움
        }
    });
    /*]]>*/
</script>
</body>
</html>