<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>CancelCare - AI ì˜ë£Œ ìƒë‹´ ì„œë¹„ìŠ¤</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/chat.css}">

    <style>
        .chat-item {
            transition: background-color 0.3s ease;
            border-radius: 8px;
            margin: 4px 0;
            cursor: pointer;
        }
        .chat-item:hover {
            background-color: #4a5568;
        }
        .chat-item.active {
            background-color: #2c5282;
        }
    </style>
</head>
<body class="chat-page">

<div th:replace="~{fragments/header :: headerFragment}"></div>

<input type="hidden" id="diagnosisId" th:value="${diagnosisId != null ? diagnosisId : 1}" />

<div class="chat-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn">ìƒˆë¡œìš´ ìƒë‹´ ì‹œì‘</button>
        </div>
        <div class="chat-list">
            <div class="chat-item active" data-category="general">
                <div class="category-icon">ğŸ’¬</div>
                <div class="category-info">
                    <div class="chat-title">ì¼ë°˜ ìƒë‹´</div>
                    <div class="chat-preview">ê¸°ë³¸ì ì¸ ìƒë‹´ ì„œë¹„ìŠ¤</div>
                </div>
            </div>
            <div class="chat-item" data-category="symptoms">
                <div class="category-icon">ğŸ¤’</div>
                <div class="category-info">
                    <div class="chat-title">ì¦ìƒ ë¬¸ì˜</div>
                    <div class="chat-preview">ì¦ìƒì— ëŒ€í•œ ë¬¸ì˜</div>
                </div>
            </div>
            <div class="chat-item" data-category="prevention">
                <div class="category-icon">ğŸ›¡ï¸</div>
                <div class="category-info">
                    <div class="chat-title">ì˜ˆë°© ê´€ë¦¬</div>
                    <div class="chat-preview">ì§ˆë³‘ ì˜ˆë°© ë° ê´€ë¦¬</div>
                </div>
            </div>
            <div class="chat-item" data-category="checkup">
                <div class="category-icon">ğŸ©º</div>
                <div class="category-info">
                    <div class="chat-title">ê²€ì§„ ì •ë³´</div>
                    <div class="chat-preview">ê±´ê°•ê²€ì§„ ê´€ë ¨ ì •ë³´</div>
                </div>
            </div>
            <div class="chat-item" data-category="nutrition">
                <div class="category-icon">ğŸ¥—</div>
                <div class="category-info">
                    <div class="chat-title">ì˜ì–‘ ìƒë‹´</div>
                    <div class="chat-preview">ì˜ì–‘ ë° ì‹ë‹¨ ìƒë‹´</div>
                </div>
            </div>
        </div>
        <div class="sidebar-footer" sec:authorize="isAuthenticated()">
            <div class="user-info">
                <div class="user-avatar" th:text="${#strings.substring(#authentication.name, 0, 1).toUpperCase()}">U</div>
                <div>
                    <div style="font-size: 14px; font-weight: 500;" sec:authentication="name">ì‚¬ìš©ìì´ë¦„</div>
                    <div style="font-size: 12px; color: #bdc3c7;">ì˜¨ë¼ì¸</div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-chat">
         <div class="chat-header">
            <div class="ai-avatar">AI</div>
            <div class="ai-info">
                <h3>CancelCare AI ìƒë‹´</h3>
                <div class="ai-status">ì˜ë£Œ ìƒë‹´ ì„œë¹„ìŠ¤</div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div th:each="message : ${chatHistory}" class="message" th:classappend="${message.sender.name() == 'user'} ? 'user' : 'ai'">
                <div class="message-avatar"
                     th:text="${message.sender.name() == 'user'} ? ${#strings.substring(#authentication.name, 0, 1).toUpperCase()} : 'AI'">
                </div>
                <div class="message-content" th:text="${message.messageText}"></div>
            </div>
        </div>

        <div class="chat-input-container">
            <form id="chatForm">
                <div class="chat-input-wrapper">
                    <textarea name="message" id="messageInput" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1" required></textarea>
                    <button type="submit" class="send-btn" id="sendBtn" disabled>
                        <svg width="20" height="20" viewBox="0_0_24_24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13"></path>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<div th:replace="~{fragments/footer :: footerFragment}"></div>

<script th:inline="javascript">
/*<![CDATA[*/
document.addEventListener('DOMContentLoaded', function() {
    // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const newChatBtn = document.querySelector('.new-chat-btn');
    const chatItems = document.querySelectorAll('.chat-item');

    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì´ë¦„ì˜ ì²« ê¸€ì
    const currentUserInitial = /*[[${#authorization.expression('isAuthenticated()')} ? ${#strings.substring(#authentication.name, 0, 1).toUpperCase()} : 'U']]*/ 'U';

    // --- í•¨ìˆ˜ ì •ì˜ ---

    // ì±„íŒ… ìŠ¤í¬ë¡¤ì„ í•­ìƒ ë§¨ ì•„ë˜ë¡œ ì´ë™
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ (kyoungjun ë¸Œëœì¹˜ ê¸°ëŠ¥ì— í•„ìš”)
    function addMessage(text, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
        const avatar = isUser ? currentUserInitial : 'AI';
        messageDiv.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">${text.replace(/\n/g, '<br>')}</div>
        `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }
    
    // --- 'kyoungjun' ë¸Œëœì¹˜ì˜ ìƒˆë¡œìš´ ê¸°ëŠ¥ë“¤ ---

    // ìƒˆë¡œìš´ ìƒë‹´ ì„¸ì…˜ ì‹œì‘ í•¨ìˆ˜
    function startNewChatSession() {
        const diagnosisId = document.getElementById('diagnosisId').value;
        const csrfToken = document.querySelector("meta[name='_csrf']").content;
        const csrfHeader = document.querySelector("meta[name='_csrf_header']").content;

        newChatBtn.disabled = true;
        newChatBtn.textContent = 'ì‹œì‘ ì¤‘...';

        fetch('/chat/new-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({ diagnosisId: parseInt(diagnosisId) })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                clearChatMessages();
                if (data.welcomeMessage) {
                    addMessage(data.welcomeMessage, false);
                }
                showNotification('ìƒˆë¡œìš´ ìƒë‹´ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } else {
                showNotification(data.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        })
        .finally(() => {
            newChatBtn.disabled = false;
            newChatBtn.textContent = 'ìƒˆë¡œìš´ ìƒë‹´ ì‹œì‘';
        });
    }

    // ì±„íŒ… í™”ë©´ ì´ˆê¸°í™” í•¨ìˆ˜
    function clearChatMessages() {
        chatMessages.innerHTML = '';
    }

    // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.textContent = message;
        // ìŠ¤íƒ€ì¼ ì§ì ‘ ì ìš©
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '1000';
        notification.style.padding = '12px 24px';
        notification.style.borderRadius = '6px';
        notification.style.color = 'white';
        notification.style.background = type === 'success' ? '#10b981' : '#ef4444';
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }
    
    // ì¹´í…Œê³ ë¦¬ ì„ íƒ í•¨ìˆ˜
    function selectCategory(selectedItem, category) {
        chatItems.forEach(item => item.classList.remove('active'));
        selectedItem.classList.add('active');

        const categoryMessages = {
            'general': 'ì¼ë°˜ ìƒë‹´ì„ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?',
            'symptoms': 'ì¦ìƒ ë¬¸ì˜ë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ì–´ë–¤ ì¦ìƒì´ ìˆìœ¼ì‹ ê°€ìš”?',
            'prevention': 'ì˜ˆë°© ê´€ë¦¬ë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ì–´ë–¤ ì˜ˆë°©ë²•ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?',
            'checkup': 'ê²€ì§„ ì •ë³´ë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ì–´ë–¤ ê²€ì§„ ì •ë³´ë¥¼ ì›í•˜ì‹œë‚˜ìš”?',
            'nutrition': 'ì˜ì–‘ ìƒë‹´ì„ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ì˜ì–‘ ê´€ë ¨ ì§ˆë¬¸ì„ í•´ë³´ì„¸ìš”!'
        };
        showNotification(categoryMessages[category], 'success');
    }

    // --- ê¸°ì¡´ ê¸°ëŠ¥ ---

    // ì„œë²„ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
    function sendMessage() {
        const messageText = messageInput.value.trim();
        const diagnosisId = document.getElementById('diagnosisId').value;
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        if (!messageText) return;

        addMessage(messageText, true);

        fetch('/chat/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({
                message: messageText,
                diagnosisId: parseInt(diagnosisId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addMessage(data.response, false);
            } else {
                addMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', false);
        });

        messageInput.value = '';
        messageInput.style.height = 'auto';
        sendBtn.disabled = true;
    }

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
    scrollToBottom();

    // ì…ë ¥ì°½ ìë™ ë†’ì´ ì¡°ì ˆ ë° ì „ì†¡ ë²„íŠ¼ í™œì„±í™”
    messageInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        sendBtn.disabled = !this.value.trim();
    });

    // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
    messageInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) {
                sendMessage();
            }
        }
    });

    // í¼ ì œì¶œ(ì „ì†¡ ë²„íŠ¼ í´ë¦­) ì‹œ ë©”ì‹œì§€ ì „ì†¡
    chatForm.addEventListener('submit', function (e) {
        e.preventDefault();
        sendMessage();
    });
    
    // 'kyoungjun' ë¸Œëœì¹˜ì˜ 'ìƒˆë¡œìš´ ìƒë‹´ ì‹œì‘' ë²„íŠ¼ ì´ë²¤íŠ¸
    newChatBtn.addEventListener('click', function() {
        if (confirm('ìƒˆë¡œìš´ ìƒë‹´ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ ëŒ€í™” ë‚´ìš©ì´ ì‚­ì œë©ë‹ˆë‹¤.')) {
            startNewChatSession();
        }
    });
    
    // 'kyoungjun' ë¸Œëœì¹˜ì˜ ì‚¬ì´ë“œë°” ì¹´í…Œê³ ë¦¬ ì„ íƒ ì´ë²¤íŠ¸
    chatItems.forEach(item => {
        item.addEventListener('click', function() {
            const category = this.dataset.category;
            selectCategory(this, category);
        });
    });

    // ì§„ë‹¨ í˜ì´ì§€ì—ì„œ ë„˜ì–´ì˜¨ ê²½ìš°, ì²« ì§ˆë¬¸ ìë™ ì „ì†¡
    const urlParams = new URLSearchParams(window.location.search);
    const diagnosisResult = url.params.get('diagnosis');
    if (diagnosisResult) {
        addMessage(`'${diagnosisResult}' ì§„ë‹¨ ê²°ê³¼ì— ëŒ€í•´ ë” ìì„¸íˆ ì•Œë ¤ì£¼ì„¸ìš”.`, true);
        messageInput.value = `'${diagnosisResult}' ì§„ë‹¨ ê²°ê³¼ì— ëŒ€í•´ ë” ìì„¸íˆ ì•Œë ¤ì£¼ì„¸ìš”.`;
        sendMessage();
        messageInput.value = '';
    }
});
/*]]>*/
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
</style>

</body>
</html>