<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CancelCare - AI ì˜ë£Œ ìƒë‹´ ì„œë¹„ìŠ¤</title>

    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/chat.css}">
    
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>
<body>

<div th:replace="~{fragments/header :: headerFragment}"></div>

<input type="hidden" id="diagnosisId" th:value="${diagnosisId != null ? diagnosisId : 1}" />

<div class="chat-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="startNewChat()">
                ìƒˆë¡œìš´ ìƒë‹´ ì‹œì‘
            </button>
        </div>
        <div class="chat-list">
            <div class="chat-item active" onclick="selectCategory('general')">
                <div class="category-icon">ğŸ’¬</div>
                <div class="category-info">
                    <div class="chat-title">ì¼ë°˜ ìƒë‹´</div>
                    <div class="chat-preview">ê¸°ë³¸ì ì¸ ìƒë‹´ ì„œë¹„ìŠ¤</div>
                </div>
            </div>
            <div class="chat-item" onclick="selectCategory('symptoms')">
                <div class="category-icon">ğŸ©º</div>
                <div class="category-info">
                    <div class="chat-title">ì¦ìƒ ë¬¸ì˜</div>
                    <div class="chat-preview">ì¦ìƒì— ëŒ€í•œ ë¬¸ì˜</div>
                </div>
            </div>
            <div class="chat-item" onclick="selectCategory('prevention')">
                <div class="category-icon">ğŸ›¡ï¸</div>
                <div class="category-info">
                    <div class="chat-title">ì˜ˆë°© ê´€ë¦¬</div>
                    <div class="chat-preview">ì§ˆë³‘ ì˜ˆë°© ë° ê´€ë¦¬</div>
                </div>
            </div>
            <div class="chat-item" onclick="selectCategory('checkup')">
                <div class="category-icon">ğŸ“‹</div>
                <div class="category-info">
                    <div class="chat-title">ê²€ì§„ ì •ë³´</div>
                    <div class="chat-preview">ê±´ê°•ê²€ì§„ ê´€ë ¨ ì •ë³´</div>
                </div>
            </div>
            <div class="chat-item" onclick="selectCategory('nutrition')">
                <div class="category-icon">ğŸ¥—</div>
                <div class="category-info">
                    <div class="chat-title">ì˜ì–‘ ìƒë‹´</div>
                    <div class="chat-preview">ì˜ì–‘ ë° ì‹ë‹¨ ìƒë‹´</div>
                </div>
            </div>
        </div>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">í™</div>
                <div>
                    <div style="font-size: 14px; font-weight: 500;">í™ê¸¸ë™</div>
                    <div style="font-size: 12px; color: #bdc3c7;">ì˜¨ë¼ì¸</div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-chat">
         <div class="chat-header">
            <div class="ai-avatar">AI</div>
            <div class="ai-info">
                <h3>CancelCare AI ìƒë‹´</h3>
                <div class="ai-status">ì˜ë£Œ ìƒë‹´ ì„œë¹„ìŠ¤</div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    ì•ˆë…•í•˜ì„¸ìš”! CancelCare AI ìƒë‹´ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ì™¼ìª½ ìƒë‹´ ì£¼ì œë¥¼ ì„ íƒí•˜ì‹œê±°ë‚˜ ê¶ê¸ˆí•œ ì ì„ ë§ì”€í•´ì£¼ì„¸ìš”.
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <form action="#" method="post" id="chatForm">
                <div class="chat-input-wrapper">
                        <textarea
                                name="message"
                                id="messageInput"
                                class="chat-input"
                                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                                rows="1"
                                required
                        ></textarea>
                    <button type="submit" class="send-btn" id="sendBtn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13"></path>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // --- ê¸°ì¡´ ì½”ë“œ ì‹œì‘ (ì „í˜€ ë³€ê²½ë˜ì§€ ì•ŠìŒ) ---
    // DOM ìš”ì†Œë“¤
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');

    // ìë™ ë†’ì´ ì¡°ì ˆ
    messageInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        sendBtn.disabled = !this.value.trim();
    });

    // ì—”í„°í‚¤ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
    messageInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (this.value.trim()) {
                sendMessage();
            }
        }
    });

    // ì±„íŒ… ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
    window.addEventListener('load', scrollToBottom);

    // ìƒˆ ìƒë‹´ ì‹œì‘
    function startNewChat() {
        alert('ìƒˆë¡œìš´ ìƒë‹´ì„ ì‹œì‘í•©ë‹ˆë‹¤!');
    }

    // ìƒë‹´ ì£¼ì œ ì„ íƒ
    function selectCategory(category) {
        document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
        event.target.closest('.chat-item').classList.add('active');
        const categoryMessages = {
            'general': 'ì¼ë°˜ ìƒë‹´ì„ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?',
            'symptoms': 'ì¦ìƒ ë¬¸ì˜ë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ì–´ë–¤ ì¦ìƒì´ ìˆìœ¼ì‹ ê°€ìš”?',
            'prevention': 'ì˜ˆë°© ê´€ë¦¬ë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ì–´ë–¤ ì˜ˆë°©ë²•ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?',
            'checkup': 'ê²€ì§„ ì •ë³´ë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ì–´ë–¤ ê²€ì§„ ì •ë³´ë¥¼ ì›í•˜ì‹œë‚˜ìš”?',
            'nutrition': 'ì˜ì–‘ ìƒë‹´ì„ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤. ì˜ì–‘ ê´€ë ¨ ì§ˆë¬¸ì„ í•´ë³´ì„¸ìš”!'
        };
        alert(categoryMessages[category]);
    }

    // ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
        const messageText = messageInput.value.trim();
        const diagnosisId = document.getElementById('diagnosisId').value;
        // âœ¨ [ì¶”ê°€] CSRF í† í°ì„ ì—¬ê¸°ì„œ ì½ì–´ì˜µë‹ˆë‹¤.
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        if (!messageText) return;
        
        addMessage(messageText, true);
        
        // âœ¨ [ìˆ˜ì •] fetch ìš”ì²­ì— CSRF í—¤ë”ë¥¼ í¬í•¨í•˜ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.
        fetch('/chat/send', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({
                message: messageText,
                diagnosisId: parseInt(diagnosisId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addMessage(data.response, false);
            } else {
                addMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', false);
        });

        messageInput.value = '';
        sendBtn.disabled = true;
    }

    // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
    function addMessage(text, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
        messageDiv.innerHTML = `
            <div class="message-avatar">${isUser ? 'í™' : 'AI'}</div>
            <div class="message-content">${text.replace(/\n/g, '<br>')}</div>
        `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // í¼ ì „ì†¡ ì²˜ë¦¬
    chatForm.addEventListener('submit', function (e) {
        e.preventDefault();
        sendMessage();
    });
    // --- ê¸°ì¡´ ì½”ë“œ ë ---

    // âœ¨âœ¨ --- [ì—¬ê¸°ì— ê¸°ëŠ¥ë§Œ ì¶”ê°€] --- âœ¨âœ¨
    // í˜ì´ì§€ê°€ ì™„ì „íˆ ë¡œë“œë˜ë©´ ì§„ë‹¨ ê²°ê³¼ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¡œì§
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const diagnosisResult = urlParams.get('diagnosis');

        // URLì— 'diagnosis' íŒŒë¼ë¯¸í„°ê°€ ìˆì„ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        if (diagnosisResult) {
            // 1. ê¸°ì¡´ì˜ addMessage í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì§„ë‹¨ ê²°ê³¼ë¥¼ ì‚¬ìš©ì ë©”ì‹œì§€ë¡œ í‘œì‹œ
            addMessage(diagnosisResult, true);
            
            // 2. ë©”ì‹œì§€ ì…ë ¥ì°½ì„ ë¹„ìš°ê³ , ì§„ë‹¨ ê²°ê³¼ë¥¼ ì„œë²„ë¡œ ì „ì†¡
            messageInput.value = diagnosisResult; // sendMessageê°€ ì…ë ¥ì°½ì„ ê¸°ì¤€ìœ¼ë¡œ ë™ì‘í•˜ë¯€ë¡œ ê°’ì„ ì ì‹œ ë„£ì–´ì¤Œ
            sendMessage(); // ê¸°ì¡´ì˜ sendMessage í•¨ìˆ˜ë¥¼ ê·¸ëŒ€ë¡œ í˜¸ì¶œ
            messageInput.value = ''; // ì „ì†¡ í›„ ë‹¤ì‹œ ë¹„ì›Œì¤Œ
        }
    });
</script>
</body>
</html>