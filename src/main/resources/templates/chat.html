<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CancelCare - AI 의료 상담 서비스</title>

    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/chat.css}">
    
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>
<body>

<div th:replace="~{fragments/header :: headerFragment}"></div>

<input type="hidden" id="diagnosisId" th:value="${diagnosisId != null ? diagnosisId : 1}" />

<div class="chat-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="startNewChat()">
                새로운 상담 시작
            </button>
        </div>
        <div class="chat-list">
            <div class="chat-item active" onclick="selectCategory('general')">
                <div class="category-icon">💬</div>
                <div class="category-info">
                    <div class="chat-title">일반 상담</div>
                    <div class="chat-preview">기본적인 상담 서비스</div>
                </div>
            </div>
            <div class="chat-item" onclick="selectCategory('symptoms')">
                <div class="category-icon">🩺</div>
                <div class="category-info">
                    <div class="chat-title">증상 문의</div>
                    <div class="chat-preview">증상에 대한 문의</div>
                </div>
            </div>
            <div class="chat-item" onclick="selectCategory('prevention')">
                <div class="category-icon">🛡️</div>
                <div class="category-info">
                    <div class="chat-title">예방 관리</div>
                    <div class="chat-preview">질병 예방 및 관리</div>
                </div>
            </div>
            <div class="chat-item" onclick="selectCategory('checkup')">
                <div class="category-icon">📋</div>
                <div class="category-info">
                    <div class="chat-title">검진 정보</div>
                    <div class="chat-preview">건강검진 관련 정보</div>
                </div>
            </div>
            <div class="chat-item" onclick="selectCategory('nutrition')">
                <div class="category-icon">🥗</div>
                <div class="category-info">
                    <div class="chat-title">영양 상담</div>
                    <div class="chat-preview">영양 및 식단 상담</div>
                </div>
            </div>
        </div>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">홍</div>
                <div>
                    <div style="font-size: 14px; font-weight: 500;">홍길동</div>
                    <div style="font-size: 12px; color: #bdc3c7;">온라인</div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-chat">
         <div class="chat-header">
            <div class="ai-avatar">AI</div>
            <div class="ai-info">
                <h3>CancelCare AI 상담</h3>
                <div class="ai-status">의료 상담 서비스</div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    안녕하세요! CancelCare AI 상담서비스입니다. 왼쪽 상담 주제를 선택하시거나 궁금한 점을 말씀해주세요.
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <form action="#" method="post" id="chatForm">
                <div class="chat-input-wrapper">
                        <textarea
                                name="message"
                                id="messageInput"
                                class="chat-input"
                                placeholder="메시지를 입력하세요..."
                                rows="1"
                                required
                        ></textarea>
                    <button type="submit" class="send-btn" id="sendBtn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13"></path>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // --- 기존 코드 시작 (전혀 변경되지 않음) ---
    // DOM 요소들
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');

    // 자동 높이 조절
    messageInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        sendBtn.disabled = !this.value.trim();
    });

    // 엔터키 전송 (Shift+Enter는 줄바꿈)
    messageInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (this.value.trim()) {
                sendMessage();
            }
        }
    });

    // 채팅 스크롤을 맨 아래로
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // 페이지 로드 시 스크롤을 맨 아래로
    window.addEventListener('load', scrollToBottom);

    // 새 상담 시작
    function startNewChat() {
        alert('새로운 상담을 시작합니다!');
    }

    // 상담 주제 선택
    function selectCategory(category) {
        document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
        event.target.closest('.chat-item').classList.add('active');
        const categoryMessages = {
            'general': '일반 상담을 선택하셨습니다. 무엇을 도와드릴까요?',
            'symptoms': '증상 문의를 선택하셨습니다. 어떤 증상이 있으신가요?',
            'prevention': '예방 관리를 선택하셨습니다. 어떤 예방법이 궁금하신가요?',
            'checkup': '검진 정보를 선택하셨습니다. 어떤 검진 정보를 원하시나요?',
            'nutrition': '영양 상담을 선택하셨습니다. 영양 관련 질문을 해보세요!'
        };
        alert(categoryMessages[category]);
    }

    // 메시지 전송
    function sendMessage() {
        const messageText = messageInput.value.trim();
        const diagnosisId = document.getElementById('diagnosisId').value;
        // ✨ [추가] CSRF 토큰을 여기서 읽어옵니다.
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        if (!messageText) return;
        
        addMessage(messageText, true);
        
        // ✨ [수정] fetch 요청에 CSRF 헤더를 포함하도록 수정합니다.
        fetch('/chat/send', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({
                message: messageText,
                diagnosisId: parseInt(diagnosisId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addMessage(data.response, false);
            } else {
                addMessage('오류가 발생했습니다.', false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addMessage('네트워크 오류가 발생했습니다.', false);
        });

        messageInput.value = '';
        sendBtn.disabled = true;
    }

    // 메시지 추가 함수
    function addMessage(text, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
        messageDiv.innerHTML = `
            <div class="message-avatar">${isUser ? '홍' : 'AI'}</div>
            <div class="message-content">${text.replace(/\n/g, '<br>')}</div>
        `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // 폼 전송 처리
    chatForm.addEventListener('submit', function (e) {
        e.preventDefault();
        sendMessage();
    });
    // --- 기존 코드 끝 ---

    // ✨✨ --- [여기에 기능만 추가] --- ✨✨
    // 페이지가 완전히 로드되면 진단 결과가 있는지 확인하는 로직
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const diagnosisResult = urlParams.get('diagnosis');

        // URL에 'diagnosis' 파라미터가 있을 경우에만 실행
        if (diagnosisResult) {
            // 1. 기존의 addMessage 함수를 호출하여 진단 결과를 사용자 메시지로 표시
            addMessage(diagnosisResult, true);
            
            // 2. 메시지 입력창을 비우고, 진단 결과를 서버로 전송
            messageInput.value = diagnosisResult; // sendMessage가 입력창을 기준으로 동작하므로 값을 잠시 넣어줌
            sendMessage(); // 기존의 sendMessage 함수를 그대로 호출
            messageInput.value = ''; // 전송 후 다시 비워줌
        }
    });
</script>
</body>
</html>